<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Infaq Digital - Musholla Wakaf Annur</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f8fafc; 
            color: #0f172a;
        }
        
        .gradient-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .pin-input::-webkit-outer-spin-button, .pin-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .shadow-custom { box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05); }
        
        .wifi-pulse {
            animation: wifi-blink 1.5s infinite;
        }
        @keyframes wifi-blink {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(1.1); }
            100% { opacity: 1; transform: scale(1); }
        }

        /* Custom scrollbar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8 bg-[#f8fafc]">
    <!-- Container Utama: space-y dikurangi agar lebih rapat -->
    <div id="app" class="max-w-7xl mx-auto space-y-4">
        
        <!-- Header Atas: Padding dikurangi -->
        <header class="bg-[#166534] text-white p-4 md:p-6 rounded-[1.5rem] flex justify-between items-center shadow-lg border-b-4 border-[#14532d]">
            <div>
                <h1 class="font-black text-base md:text-xl tracking-tight uppercase">Musholla Wakaf Annur</h1>
                <p class="text-[9px] md:text-[11px] text-[#4ade80] font-black tracking-[0.3em] uppercase">Laporan Infaq Digital System</p>
            </div>
            <div class="bg-[#14532d] px-4 py-1.5 rounded-full text-[10px] md:text-xs font-black uppercase tracking-wider border border-white/5 shadow-inner">
                <span id="currentDate">17 FEBRUARI 2026</span>
            </div>
        </header>

        <!-- Kartu Saldo Utama: Padding dikurangi -->
        <div class="gradient-blue p-8 md:p-12 rounded-[2.5rem] text-white text-center shadow-2xl shadow-blue-100 relative overflow-hidden">
            <div class="absolute top-[-40px] right-[-40px] w-64 h-64 bg-white/10 rounded-full blur-3xl"></div>
            <p class="text-[10px] md:text-xs font-black uppercase tracking-[0.4em] mb-2">Saldo Infaq Saat Ini</p>
            <h2 class="text-3xl md:text-5xl font-black tracking-tighter" id="totalBalance">Rp 0</h2>
            
            <div class="mt-4 flex items-center justify-center gap-3">
                <div id="wifiContainer" class="wifi-pulse hidden">
                    <i data-lucide="wifi" class="w-5 h-5 text-[#4ade80] stroke-[4]"></i>
                </div>
                <div id="connectionDot" class="w-2.5 h-2.5 bg-gray-400 rounded-full"></div>
                <p id="connectionText" class="text-[10px] md:text-xs font-black tracking-[0.2em] uppercase text-white">Menghubungkan...</p>
            </div>
        </div>

        <!-- Ringkasan: Gap dikurangi -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-white p-6 md:p-8 rounded-[2rem] border-l-[10px] border-[#10b981] shadow-custom flex flex-col justify-center">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Pemasukan</p>
                <p class="text-xl md:text-3xl font-black text-[#10b981]" id="totalIncome">Rp 0</p>
            </div>
            <div class="bg-white p-6 md:p-8 rounded-[2rem] border-l-[10px] border-[#ef4444] shadow-custom flex flex-col justify-center">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1">Total Pengeluaran</p>
                <p class="text-xl md:text-3xl font-black text-[#ef4444]" id="totalExpense">Rp 0</p>
            </div>
        </div>

        <!-- Form Input: Spasi internal dikurangi -->
        <div class="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-custom border border-gray-50 space-y-6">
            <div class="flex items-center gap-3 border-l-8 border-[#166534] pl-4">
                <h3 id="formTitle" class="font-black text-base md:text-xl uppercase tracking-widest text-[#166534]">Input Data Infaq</h3>
            </div>

            <div class="space-y-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">TGL TRANSAKSI</label>
                        <input type="date" id="inputDate" class="w-full bg-[#f8fafc] border border-gray-200 rounded-xl p-4 text-sm font-black outline-none focus:ring-4 focus:ring-green-50 transition-all">
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">KATEGORI INFAQ</label>
                        <div class="flex bg-gray-100 p-1.5 rounded-xl">
                            <button onclick="setCategory('MASUK')" id="btnMasuk" class="flex-1 py-3 text-[10px] font-black rounded-lg transition-all bg-[#10b981] text-white shadow-lg">MASUK</button>
                            <button onclick="setCategory('KELUAR')" id="btnKeluar" class="flex-1 py-3 text-[10px] font-black rounded-lg transition-all text-gray-400">KELUAR</button>
                        </div>
                    </div>
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">KETERANGAN / DESKRIPSI</label>
                    <input type="text" id="inputDesc" placeholder="CONTOH: INFAQ JUMAT BERKAH" class="w-full bg-[#f8fafc] border border-gray-200 rounded-xl p-4 text-sm font-black outline-none focus:ring-4 focus:ring-green-50 transition-all placeholder:text-gray-300">
                </div>

                <div class="space-y-2">
                    <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest">NOMINAL (RP)</label>
                    <div class="relative">
                        <span class="absolute left-5 top-1/2 -translate-y-1/2 text-xl font-black text-gray-300">Rp</span>
                        <input type="number" id="inputAmount" inputmode="numeric" placeholder="0" class="w-full bg-[#f8fafc] border border-gray-200 rounded-2xl p-5 pl-14 text-2xl md:text-3xl font-black text-[#166534] outline-none focus:ring-4 focus:ring-green-50 transition-all">
                    </div>
                </div>

                <div id="buttonGroup" class="flex flex-col md:flex-row gap-3">
                    <button onclick="openPinModal()" id="submitBtn" class="flex-1 bg-[#10b981] text-white py-6 rounded-[1.5rem] font-black text-base md:text-lg uppercase tracking-[0.3em] shadow-xl shadow-green-100 hover:bg-[#059669] transition-all flex items-center justify-center gap-4 active:scale-95">
                        <i data-lucide="check-circle" class="w-6 h-6"></i>
                        KONFIRMASI & SIMPAN
                    </button>
                    <button onclick="cancelEdit()" id="cancelBtn" class="hidden flex-initial bg-rose-500 text-white px-8 py-6 rounded-[1.5rem] font-black text-base uppercase tracking-widest shadow-xl shadow-rose-100 hover:bg-rose-600 transition-all flex items-center justify-center gap-4">
                        <i data-lucide="x-circle" class="w-6 h-6"></i>
                        BATAL
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabel Riwayat: Padding dikurangi -->
        <div class="bg-white p-6 md:p-10 rounded-[2.5rem] shadow-custom border border-gray-50 space-y-6">
            <div class="flex items-center gap-4">
                <i data-lucide="history" class="w-6 h-6 text-[#10b981]"></i>
                <h3 class="font-black text-base md:text-xl uppercase tracking-widest text-[#166534]">Laporan Mutasi Infaq</h3>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[800px]">
                    <thead class="text-[10px] font-black text-gray-400 uppercase tracking-[0.3em] border-b-4 border-gray-50">
                        <tr>
                            <th class="pb-4">TGL</th>
                            <th class="pb-4">KETERANGAN</th>
                            <th class="pb-4 text-right">MASUK</th>
                            <th class="pb-4 text-right">KELUAR</th>
                            <th class="pb-4 text-right">OPSI</th>
                        </tr>
                    </thead>
                    <tbody id="transactionList" class="divide-y divide-gray-50">
                        <tr>
                            <td colspan="5" class="py-10 text-center text-gray-300 text-xs font-black uppercase tracking-widest">MEMUAT DATA...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- PIN Modal -->
    <div id="pinModal" class="fixed inset-0 bg-black/80 backdrop-blur-md hidden flex items-center justify-center p-6 z-50">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-10 text-center space-y-8 shadow-2xl animate-in fade-in zoom-in duration-300">
            <div class="w-20 h-20 bg-blue-50 text-blue-600 rounded-3xl flex items-center justify-center mx-auto rotate-12">
                <i data-lucide="shield-check" class="w-10 h-10"></i>
            </div>
            <div class="space-y-2">
                <h4 class="font-black text-xl uppercase tracking-tight">Otoritas PIN</h4>
                <p class="text-xs font-black text-gray-400 uppercase tracking-widest">PIN 6 Digit (999999)</p>
            </div>
            <input type="password" id="pinInput" maxlength="6" inputmode="numeric" class="w-full text-center text-4xl font-black tracking-[0.6em] border-b-4 border-blue-600 outline-none py-4 bg-gray-50 rounded-t-2xl" placeholder="••••••">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="closePinModal()" class="py-4 bg-gray-100 text-gray-600 font-black rounded-2xl text-[10px] uppercase tracking-widest">BATAL</button>
                <button onclick="verifyAndSubmit()" class="py-4 bg-blue-600 text-white font-black rounded-2xl text-[10px] uppercase tracking-widest shadow-lg shadow-blue-100">VERIFIKASI</button>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-12 right-12 bg-gray-900 text-white px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest hidden z-[100] shadow-2xl"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'annur-digital-v3';

        let transactions = [];
        let currentCategory = 'MASUK';
        let editingId = null;
        const CORRECT_PIN = "999999";
        let currentUser = null;

        const elAmount = document.getElementById('inputAmount');
        const elDesc = document.getElementById('inputDesc');
        const elDate = document.getElementById('inputDate');
        const submitBtn = document.getElementById('submitBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const formTitle = document.getElementById('formTitle');

        const saveDraft = () => {
            if (editingId) return; 
            const draft = { amount: elAmount.value, desc: elDesc.value, date: elDate.value, category: currentCategory };
            localStorage.setItem('annur_draft_final', JSON.stringify(draft));
        };

        const loadDraft = () => {
            const saved = localStorage.getItem('annur_draft_final');
            if (saved) {
                const draft = JSON.parse(saved);
                elAmount.value = draft.amount || "";
                elDesc.value = draft.desc || "";
                if (draft.date) elDate.value = draft.date;
                if (draft.category) setCategory(draft.category);
            }
        };

        elAmount.addEventListener('input', saveDraft);
        elDesc.addEventListener('input', saveDraft);
        elDate.addEventListener('change', saveDraft);

        window.setCategory = (cat) => {
            currentCategory = cat;
            const btnMasuk = document.getElementById('btnMasuk');
            const btnKeluar = document.getElementById('btnKeluar');
            if (cat === 'MASUK') {
                btnMasuk.className = "flex-1 py-3 text-[10px] font-black rounded-lg bg-[#10b981] text-white shadow-lg";
                btnKeluar.className = "flex-1 py-3 text-[10px] font-black text-gray-500";
            } else {
                btnKeluar.className = "flex-1 py-3 text-[10px] font-black rounded-xl bg-[#ef4444] text-white shadow-lg";
                btnMasuk.className = "flex-1 py-3 text-[10px] font-black text-gray-500";
            }
            saveDraft();
        };

        window.openPinModal = () => {
            if (!currentUser) return showToast("MENUNGGU KONEKSI...");
            if (!elAmount.value || elAmount.value <= 0) return showToast("NOMINAL KOSONG!");
            if (!elDesc.value) return showToast("KETERANGAN KOSONG!");
            document.getElementById('pinModal').classList.remove('hidden');
            document.getElementById('pinInput').focus();
        };

        window.closePinModal = () => {
            document.getElementById('pinModal').classList.add('hidden');
            document.getElementById('pinInput').value = "";
        };

        window.verifyAndSubmit = async () => {
            if (document.getElementById('pinInput').value !== CORRECT_PIN) {
                showToast("PIN SALAH!");
                document.getElementById('pinInput').value = "";
                return;
            }

            const payload = {
                date: elDate.value,
                description: elDesc.value.toUpperCase(),
                category: currentCategory,
                amount: parseFloat(elAmount.value),
                updatedAt: Date.now()
            };

            try {
                if (editingId) {
                    const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'transactions', editingId);
                    await updateDoc(docRef, payload);
                    showToast("DATA BERHASIL DIPERBARUI");
                    cancelEdit();
                } else {
                    payload.createdAt = Date.now();
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'transactions');
                    await addDoc(colRef, payload);
                    showToast("DATA BERHASIL DISIMPAN");
                    localStorage.removeItem('annur_draft_final'); 
                    resetForm();
                }
                closePinModal();
            } catch (e) { 
                console.error(e);
                showToast("GAGAL MENYIMPAN!"); 
            }
        };

        window.startEdit = (id) => {
            const tx = transactions.find(t => t.id === id);
            if (!tx) return;

            editingId = id;
            elAmount.value = tx.amount;
            elDesc.value = tx.description;
            elDate.value = tx.date;
            setCategory(tx.category);

            formTitle.innerText = "Edit Data Infaq";
            submitBtn.innerHTML = `<i data-lucide="refresh-cw" class="w-6 h-6 md:w-8 md:h-8"></i> UPDATE DATA`;
            cancelBtn.classList.remove('hidden');
            lucide.createIcons();
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.cancelEdit = () => {
            editingId = null;
            resetForm();
            formTitle.innerText = "Input Data Infaq";
            submitBtn.innerHTML = `<i data-lucide="check-circle" class="w-6 h-6 md:w-8 md:h-8"></i> KONFIRMASI & SIMPAN`;
            cancelBtn.classList.add('hidden');
            lucide.createIcons();
            loadDraft();
        };

        function resetForm() {
            elAmount.value = ""; elDesc.value = "";
            elDate.value = new Date().toISOString().split('T')[0];
            setCategory('MASUK');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.classList.remove('hidden');
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        function formatRupiah(num) {
            return "Rp " + new Intl.NumberFormat('id-ID').format(num);
        }

        function updateUI() {
            let totalIn = 0; let totalOut = 0;
            const listEl = document.getElementById('transactionList');
            listEl.innerHTML = "";
            if (transactions.length === 0) {
                listEl.innerHTML = `<tr><td colspan="5" class="py-10 text-center text-gray-300 text-sm font-black uppercase tracking-widest">DATA KOSONG</td></tr>`;
            }
            const sortedData = [...transactions].sort((a, b) => new Date(b.date) - new Date(a.date) || b.createdAt - a.createdAt);
            sortedData.forEach(tx => {
                const isMasuk = tx.category === 'MASUK';
                if (isMasuk) totalIn += tx.amount; else totalOut += tx.amount;
                const row = document.createElement('tr');
                row.className = "hover:bg-gray-50 transition-all group";
                row.innerHTML = `
                    <td class="py-4 text-gray-500 font-black text-sm">${tx.date ? tx.date.split('-').reverse().join('/') : ''}</td>
                    <td class="py-4 font-black text-[#1e2d24] text-base uppercase">${tx.description}</td>
                    <td class="py-4 text-right font-black text-[#10b981] text-sm">
                        ${isMasuk ? formatRupiah(tx.amount) : '-'}
                    </td>
                    <td class="py-4 text-right font-black text-[#ef4444] text-sm">
                        ${!isMasuk ? formatRupiah(tx.amount) : '-'}
                    </td>
                    <td class="py-4 text-right">
                        <button onclick="startEdit('${tx.id}')" class="bg-blue-50 text-blue-600 px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all">
                            EDIT
                        </button>
                    </td>
                `;
                listEl.appendChild(row);
            });
            document.getElementById('totalBalance').innerText = formatRupiah(totalIn - totalOut);
            document.getElementById('totalIncome').innerText = formatRupiah(totalIn);
            document.getElementById('totalExpense').innerText = formatRupiah(totalOut);
        }

        async function init() {
            const today = new Date();
            const months = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
       
